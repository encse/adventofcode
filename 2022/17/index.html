<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <link href='https://fonts.googleapis.com/css?family=Noto Sans' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/csharp.min.js"></script>
    <title>Advent of Code 2022/17 'Pyroclastic Flow'' in C# by encse</title>

    <head>
        <meta property="og:title" content="Advent of Code 2022/17 'Pyroclastic Flow' in C# by encse<">
        <meta property="og:description" content="C# solution to the 'Pyroclastic Flow' Advent of Code problem.">
        <meta property="og:image" content="https://aoc.csokavar.hu/2022/17//illustration.jpeg">
        <meta property="og:url" content="https://aoc.csokavar.hu/2022/17/">
        <meta property="og:type" content="website">
      </head>


    <style>
        html {
            --theme-background-color: #2b2b2b;
            --theme-background-color2: #0d1117;
        }

        * {
            box-sizing: border-box;
            /* text is too big without these in my iphone */
            -moz-text-size-adjust: none;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }

        @media (min-width:2000px) {
            html {
                font-size: 1.9em;
            }
        }

        a {
            color: inherit;
        }

        body {
            background: var(--theme-background-color);
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans', 'Arial', sans-serif;
            color: white;
        }

        .main {
            width: 100ch;
            display: flex;
            flex-direction: column;
            padding: 1em;
            margin: 4em auto;
        }


        .header-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap-reverse;
            justify-content: center;
            gap: 1em;
            overflow: hidden;
            position: relative;
        }

        .header-image {
            display: flex;
            min-width: 400px;
            position: relative;
            position: absolute;
            z-index: -1;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .header-image img {
            object-fit: cover;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.7); 
            padding: 10em;
            background-image: radial-gradient(rgba(194, 194, 194, 0.13), rgba(195, 195, 195, 0.25));
        }

        .header-title h2 {
            font-size: 400%;
            margin: 0;
        }

        .header-title p {
            font-size: 150%;
        }

        #dropdown-label {
            text-align: center;
        }
         #dropdown-label  span {
            padding: 0;
            margin: 0 0.25em;
        }

        .dropdown-toggle {
            display: none; /* Hide the checkbox */
        }

        .dropdown-content {
            display: none;
            position: absolute;
            z-index: 1;
            list-style: none;
            background-color: #0d1117;
        }

        .dropdown-content {
            flex-direction: column;
            padding: 1em;
            gap: 0.5em;
            padding: 1em;
        }
        #dropdown-toggle:checked  ~ .dropdown-content {
            display: flex; 
        }

        #top-nav,
        #bottom {
            background: var(--theme-background-color2);
            padding: 1em;
        }

        #year-picker select {
            border: none;
            background: inherit;
            font-size: inherit;
            color: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        #top-nav a,
        .header-container a {
            text-decoration: none;
        }

        #top-nav .current {
            color: var(--theme-background-color2);
            background: white;
        }

        #bottom {
            background: var(--theme-background-color2);
            display: flex;
            flex-wrap: wrap;
            gap: 2em;
            justify-content: center;
        }

        #top-nav {
            display: flex;
        }

        #top-nav select {
            margin-left: 1em;
            margin-right: 1em;
        }

        #day-picker {
            display: flex;
            flex-wrap: wrap;
        }

        #day-picker a {
            margin: 1em;
        }

        #code-container {
            overflow: auto;
            scroll-behavior: smooth;
        }

        .hljs {
            background: var(--theme-background-color2);
        }

        .hljs-ln-numbers {
            padding-right: 1em !important;
            text-align: right;
        }

        .content {
            line-height: 1.5;
            margin-top: 2em;
            /* hyphens: auto; */
        }


        @media (max-width: 1024px) {
            .main {
                width: inherit;
            }

            .content {
                width: 100%;
            }


            #top-nav span,
            #top-nav .dropdown {
                padding: 0.25em;
            }

            .header-title h2 {
                font-size: 300%;
            }
        }

        @media (orientation: landscape) {
            main {
                width: 90%;
            }
        }
    </style>
</head>

<body lang="en-US">
    <div id="top-nav">
        <div id="year-picker"><nav class="dropdown">
            <input type="checkbox" id="dropdown-toggle" class="dropdown-toggle">
            <label id="dropdown-label" for="dropdown-toggle"><span class="current">2022<span></label>
            <div class="dropdown-content"><a href="/2015/25/">2015</a><a href="/2016/25/">2016</a><a href="/2017/25/">2017</a><a href="/2018/25/">2018</a><a href="/2019/25/">2019</a><a href="/2020/25/">2020</a><a href="/2021/25/">2021</a><a href="/2022/25/">2022</a><a href="/2023/25/">2023</a><a href="/2024/13/">2024</a></div>
        </nav>
     </div>
        <div id="day-picker"><span><a href="/2022/1">01</a></span><span><a href="/2022/2">02</a></span><span><a href="/2022/3">03</a></span><span><a href="/2022/4">04</a></span><span><a href="/2022/5">05</a></span><span><a href="/2022/6">06</a></span><span><a href="/2022/7">07</a></span><span><a href="/2022/8">08</a></span><span><a href="/2022/9">09</a></span><span><a href="/2022/10">10</a></span><span><a href="/2022/11">11</a></span><span><a href="/2022/12">12</a></span><span><a href="/2022/13">13</a></span><span><a href="/2022/14">14</a></span><span><a href="/2022/15">15</a></span><span><a href="/2022/16">16</a></span><span class="current"><a href="/2022/17">17</a></span><span><a href="/2022/18">18</a></span><span><a href="/2022/19">19</a></span><span><a href="/2022/20">20</a></span><span><a href="/2022/21">21</a></span><span><a href="/2022/22">22</a></span><span><a href="/2022/23">23</a></span><span><a href="/2022/24">24</a></span><span><a href="/2022/25">25</a></span></div>
    </div>
    <div class="main">
        <div class="header-container">
            <div class="header-image">
                <img id="cover" width="100%" src="illustration.jpeg" />
            </div>

            <div class="header-title">
                <p class="text">Advent of Code</p>
                <h2 id="problem-id">2022/17</h2>
                <h2 id="problem-name">Pyroclastic Flow</h2>
                <p class="text">in C#</p>
                <p class="text"></p>
                <p class="text"><em>by <a style="text-decoration: underline"
                            href="https://github.com/sponsors/encse">encse</a></em></p>
            </div>

        </div>

        <div class="content">
            <div id="notes"><p>Your handheld device has located an alternative exit from the cave for you and the elephants.  The ground is rumbling almost continuously now, but the strange valves bought you some time. It&#39;s definitely getting warmer in here, though.</p>
<p>The tunnels eventually open into a very tall, narrow chamber. Large, oddly-shaped rocks are falling into the chamber from above, presumably due to all the rumbling. If you can&#39;t work out where the rocks will fall next, you might be crushed!</p>
<p>Read the <a href="https://adventofcode.com/2022/day/17">full puzzle</a>.</p>
</div>
            <div id="code-container"><pre class="hljs language-csharp"><code>using System;
using System.Collections.Generic;
using System.Linq;

namespace AdventOfCode.Y2022.Day17;

[ProblemName("Pyroclastic Flow")]
class Solution : Solver {

    public object PartOne(string input) {
        return new Tunnel(input, 100).AddRocks(2022).Height;
    }

    public object PartTwo(string input) {
        return new Tunnel(input, 100).AddRocks(1000000000000).Height;
    }

    class Tunnel {
        int linesToStore;

        List<char[]> lines = new List<char[]>();
        long linesNotStored;

        public long Height => lines.Count + linesNotStored;

        string[][] rocks;
        string jets;
        ModCounter irock;
        ModCounter ijet;

        // Simulation runs so that only the top N lines are kept in the tunnel. 
        // This is a practical constant, there is NO THEORY BEHIND it.
        public Tunnel(string jets, int linesToStore) {
            this.linesToStore = linesToStore;
            rocks = new string[][]{
                new []{"####"},
                new []{" # ", "###", " # "},
                new []{"  #", "  #", "###"},
                new []{"#", "#", "#", "#"},
                new []{"##", "##"}
            };
            this.irock = new ModCounter(0, rocks.Length);

            this.jets = jets;
            this.ijet = new ModCounter(0, jets.Length);
        }

        public Tunnel AddRocks(long rocksToAdd) {
            // We are adding rocks one by one until we find a recurring pattern.

            // Then we can jump forward full periods with just increasing the height 
            // of the cave: the top of the cave should look the same after a full period
            // so no need to simulate he rocks anymore. 

            // Then we just add the remaining rocks. 

            var seen = new Dictionary<string, (long rocksToAdd, long height)>();
            while (rocksToAdd > 0) {
                var hash = string.Join("", lines.SelectMany(ch => ch));
                if (seen.TryGetValue(hash, out var cache)) {
                    // we have seen this pattern, advance forwad as much as possible
                    var heightOfPeriod = this.Height - cache.height;
                    var periodLength = cache.rocksToAdd - rocksToAdd;
                    linesNotStored += (rocksToAdd / periodLength) * heightOfPeriod;
                    rocksToAdd = rocksToAdd % periodLength;
                    break;
                } else {
                    seen[hash] = (rocksToAdd, this.Height);
                    this.AddRock();
                    rocksToAdd--;
                }
            }

            while (rocksToAdd > 0) {
                this.AddRock();
                rocksToAdd--;
            }
            return this;
        }

        // Adds one rock to the cave
        public Tunnel AddRock() {
            var rock = rocks[(int)irock++];

            // make room of 3 lines + the height of the rock
            for (var i = 0; i < rock.Length + 3; i++) {
                lines.Insert(0, "|       |".ToArray());
            }

            // simulate falling
            var pos = new Pos(0, 3);
            while (true) {
                var jet = jets[(int)ijet++];
                if (jet == '>' && !Hit(rock, pos.Right)) {
                    pos = pos.Right;
                } else if (jet == '<' && !Hit(rock, pos.Left)) {
                    pos = pos.Left;
                }
                if (Hit(rock, pos.Below)) {
                    break;
                }
                pos = pos.Below;
            }

            Draw(rock, pos);
            return this;
        }

        // tells if a rock can be placed in the given location or hits something
        bool Hit(string[] rock, Pos pos) =>
            Area(rock).Any(pt =>
                Get(rock, pt) == '#' &&
                Get(lines, pt + pos) != ' '
            );

        void Draw(string[] rock, Pos pos) {
            // draws a rock pattern into the cave at the given x,y coordinates,
            foreach (var pt in Area(rock)) {
                if (Get(rock, pt) == '#') {
                    Set(lines, pt + pos, '#');
                }
            }
           
            // remove empty lines from the top
            while (!lines[0].Contains('#')) {
                lines.RemoveAt(0);
            }

            // keep the tail
            while (lines.Count > linesToStore) {
                lines.RemoveAt(lines.Count - 1);
                linesNotStored ++;
            }
        }
    }

    static IEnumerable<Pos> Area(string[] mat) =>
        from irow in Enumerable.Range(0, mat.Length)
        from icol in Enumerable.Range(0, mat[0].Length)
        select new Pos(irow, icol);

    static char Get(IEnumerable<IEnumerable<char>> mat, Pos pos) {
        return (mat.ElementAtOrDefault(pos.irow) ?? "#########").ElementAt(pos.icol);
    }

    static char Set(IList<char[]> mat, Pos pos, char ch) {
        return mat[pos.irow][pos.icol] = ch;
    }

    record struct Pos(int irow, int icol) {
        public Pos Left => new Pos(irow, icol - 1);
        public Pos Right => new Pos(irow, icol + 1);
        public Pos Below => new Pos(irow + 1, icol);
        public static Pos operator +(Pos posA, Pos posB) =>
            new Pos(posA.irow + posB.irow, posA.icol + posB.icol);
    }

    record struct ModCounter(int index, int mod) {
        public static explicit operator int(ModCounter c) => c.index;
        public static ModCounter operator ++(ModCounter c) =>
            c with { index = c.index == c.mod - 1 ? 0 : c.index + 1 };
    }
}
</code></pre></div>
            <div id="code-location"> <p>Please ☆ my <a href="https://github.com/encse/adventofcode/">repo</a> if you like it!</p></div>
        </div>

    </div>
    <div id="bottom">
        <span>© <span id="currentYear">2024</span></span>
        <span><a href="https://adventofcode.com">Advent of Code</a> is a registered trademark in the US</span>
        <span>Images provided by <a href="https://www.bing.com/images/create">Bing</a> image creator</span>
    </div>
 
    <script>
        // This will automatically apply highlight.js to all <pre><code> blocks
        document.addEventListener('DOMContentLoaded', function () {

        let yearPicker = document.querySelector('#year-picker select')
        if (yearPicker) {
            yearPicker.addEventListener('change', function () {
                window.location = this.value;
            });
        }

          // Automatically highlight all <code> blocks inside <pre>
          hljs.highlightAll();
        });
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P8Y1BWSSF3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-P8Y1BWSSF3');
    </script>
</body>

</html>