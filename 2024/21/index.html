<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <link href='https://fonts.googleapis.com/css?family=Noto Sans' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/csharp.min.js"></script>
    <title>Advent of Code 2024/21 'Keypad Conundrum'' in C# by encse</title>

    <head>
        <meta property="og:title" content="Advent of Code 2024/21 'Keypad Conundrum' in C# by encse">
        <meta property="og:description" content="C# solution to the 'Keypad Conundrum' Advent of Code problem.">
        <meta property="og:image" content="https://aoc.csokavar.hu/2024/21//illustration.jpeg">
        <meta property="og:url" content="https://aoc.csokavar.hu/2024/21/">
        <meta property="og:type" content="website">
      </head>


    <style>
        html {
            --theme-background-color: #2b2b2b;
            --theme-background-color2: #0d1117;
        }

        * {
            box-sizing: border-box;
            /* text is too big without these in my iphone */
            -moz-text-size-adjust: none;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }

        @media (min-width:2000px) {
            html {
                font-size: 1.9em;
            }
        }

        a {
            color: inherit;
        }

        body {
            background: var(--theme-background-color);
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans', 'Arial', sans-serif;
            color: white;
        }

        .main {
            width: 100ch;
            display: flex;
            flex-direction: column;
            padding: 1em;
            margin: 4em auto;
        }


        .header-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap-reverse;
            justify-content: center;
            gap: 1em;
            overflow: hidden;
            position: relative;
        }

        .header-image {
            display: flex;
            min-width: 400px;
            position: relative;
            position: absolute;
            z-index: -1;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .header-image img {
            object-fit: cover;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.7); 
            padding: 10em;
            background-image: radial-gradient(rgba(194, 194, 194, 0.13), rgba(195, 195, 195, 0.25));
        }

        .header-title h2 {
            font-size: 400%;
            margin: 0;
        }

        .header-title p {
            font-size: 150%;
        }

        #dropdown-label {
            text-align: center;
            margin: 1em;
        }

        .dropdown-toggle {
            display: none; /* Hide the checkbox */
        }

        .dropdown-content {
            display: none;
            position: absolute;
            z-index: 1;
            list-style: none;
            background-color: #0d1117;
        }

        .dropdown-content {
            flex-direction: column;

        }

        .dropdown-content a {
            margin: 0.5em 1em;
        }

        #dropdown-toggle:checked  ~ .dropdown-content {
            display: flex; 
        }

        #top-nav,
        #bottom {
            background: var(--theme-background-color2);
            padding: 1em;
        }

        #year-picker select {
            border: none;
            background: inherit;
            font-size: inherit;
            color: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        #top-nav a,
        .header-container a {
            text-decoration: none;
        }

        #top-nav .current {
            color: var(--theme-background-color2);
            background: white;
        }

        #bottom {
            background: var(--theme-background-color2);
            display: flex;
            flex-wrap: wrap;
            gap: 2em;
            justify-content: center;
        }

        #top-nav {
            display: flex;
        }

        #top-nav select {
            margin-left: 1em;
            margin-right: 1em;
        }

        #day-picker {
            display: flex;
            flex-wrap: wrap;
        }

        #day-picker a {
            margin: 1em;
        }

        #code-container {
            overflow: auto;
            scroll-behavior: smooth;
        }

        .hljs {
            background: var(--theme-background-color2);
        }

        .hljs-ln-numbers {
            padding-right: 1em !important;
            text-align: right;
        }

        .content {
            line-height: 1.5;
            margin-top: 2em;
            /* hyphens: auto; */
        }

        .content img {
            width: 70%;
        }


        @media (max-width: 1024px) {
            .main {
                width: inherit;
            }

            .content {
                width: 100%;
            }


            #top-nav span,
            #top-nav .dropdown 
            #top-nav .dropdown-content {
                padding: 0.25em;
            }

            .header-title h2 {
                font-size: 300%;
            }
        }

        @media (orientation: landscape) {
            main {
                width: 90%;
            }
        }
    </style>
</head>

<body lang="en-US">
    <div id="top-nav">
        <div id="year-picker"><nav class="dropdown">
            <input type="checkbox" id="dropdown-toggle" class="dropdown-toggle">
            <span class="current"><label id="dropdown-label" for="dropdown-toggle">2024</label></span>
            <div class="dropdown-content"><a href="/2015/25/">2015</a><a href="/2016/25/">2016</a><a href="/2017/25/">2017</a><a href="/2018/25/">2018</a><a href="/2019/25/">2019</a><a href="/2020/25/">2020</a><a href="/2021/25/">2021</a><a href="/2022/25/">2022</a><a href="/2023/25/">2023</a><a href="/2024/25/">2024</a></div>
        </nav>
     </div>
        <div id="day-picker"><span><a href="/2024/1">01</a></span><span><a href="/2024/2">02</a></span><span><a href="/2024/3">03</a></span><span><a href="/2024/4">04</a></span><span><a href="/2024/5">05</a></span><span><a href="/2024/6">06</a></span><span><a href="/2024/7">07</a></span><span><a href="/2024/8">08</a></span><span><a href="/2024/9">09</a></span><span><a href="/2024/10">10</a></span><span><a href="/2024/11">11</a></span><span><a href="/2024/12">12</a></span><span><a href="/2024/13">13</a></span><span><a href="/2024/14">14</a></span><span><a href="/2024/15">15</a></span><span><a href="/2024/16">16</a></span><span><a href="/2024/17">17</a></span><span><a href="/2024/18">18</a></span><span><a href="/2024/19">19</a></span><span><a href="/2024/20">20</a></span><span class="current"><a href="/2024/21">21</a></span><span><a href="/2024/22">22</a></span><span><a href="/2024/23">23</a></span><span><a href="/2024/24">24</a></span><span><a href="/2024/25">25</a></span></div>
    </div>
    <div class="main">
        <div class="header-container">
            <div class="header-image">
                <img id="cover" width="100%" src="illustration.jpeg" />
            </div>

            <div class="header-title">
                <p class="text">Advent of Code</p>
                <h2 id="problem-id">2024/21</h2>
                <h2 id="problem-name">Keypad Conundrum</h2>
                <p class="text">in C#</p>
                <p class="text"></p>
                <p class="text"><em>by <a style="text-decoration: underline"
                            href="https://github.com/sponsors/encse">encse</a></em></p>
            </div>

        </div>

        <div class="content">
            <div id="notes"><p>As you teleport onto Santa&#39;s <em>Reindeer-class starship</em>, The Historians begin to panic: someone from their search party is <em>missing</em>. A quick life-form scan by the ship&#39;s computer reveals that when the missing Historian teleported, he arrived in another part of the ship.</p>
<p>The door to that area is locked, but the computer can&#39;t open it; it can only be opened by <em>physically typing</em> the door codes (your puzzle input) on the numeric keypad on the door.</p>
<p><em>Visit the website for the full story and <a href="https://adventofcode.com/2024/day/21">full puzzle</a> description.</em></p>
<p>This is the problem that sets casual players apart competitors. I had a hard time solving it. I think I was on track, but 
I just couldn&#39;t visualize the whole idea of robots controlling robots controlling robots. I love recursion, but just 
cannot mentally follow multiple layers of indirection. Anyway. I could solve it in the evening hours, so I&#39;m still on track with <em>Advent of Code 2024</em>.</p>
<p>It was clear from the exponential growth demonstrated by <em>part 1</em> that I wont be able to generate the final string to
be entered. Luckily the problem asked only for the length of it. (Which makes it really artifical: how would the elves enter
such a long key?)</p>
<p>I created a function called <code>EncodeKeys</code> which takes a sequence of keys to be pressed and an array of keypads, and returns the length of the shortest sequence needed to enter the given keys. An empty keypad array means that the sequence is simply entered by a human and no further encoding is needed. Otherwise, the sequence is entered by a robot that needs to be programmed using its keypad. In this case the keys are encoded using the first keypad in the array (the robot&#39;s keypad), character by character using <em>EncodeKey</em> which will recursively call back to <code>EncodeKeys</code> with the rest of the keypads.</p>
<p>The <code>_EncodeKey_</code> helper function is used to move the robot from position <em>A</em> to position <em>B</em> on the keypad and press the button. Usually, <em>A</em> and <em>B</em> are not in the same row and column, so the movement has both a horizontal and a vertical part. We could go both ways: horizontal first then vertical, or the other way around, and we need to check which movement results in fewer key presses. Lastly, we should not forget that the robot&#39;s hand should never move over the empty space <code>&#39; &#39;</code>.</p>
<p>Since every key sequence we need to enter ends with a button press <code>&#39;A&#39;</code>, we can always be sure that the robot will stay over the <code>&#39;A&#39;</code> button at the end. Since it initially starts over the <code>&#39;A&#39;</code> key as well, we have an invariant: at the beginning and the end of <code>EncodeKeys</code>, the robot is over the <code>&#39;A&#39;</code> key. It can move around while entering the keys, but the invariant holds when it finishes.</p>
<p>This is great because we don&#39;t have to keep track of it! The <code>Cache</code> used by <code>EncodeKey</code> doesn&#39;t need to care about the robot&#39;s position recursively. All it depends on is the current robot&#39;s position, the position of the next key to be entered, and the number of keypads left in the recursion. This reduces the problem space quite a bit and gives us a well-performing algorithm.</p>
</div>
            <div id="code-container"><pre class="hljs language-csharp"><code>namespace AdventOfCode.Y2024.Day21;

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;

using Cache = System.Collections.Concurrent.ConcurrentDictionary&lt;(char currentKey, char nextKey, int depth), long&gt;;
using Keypad = System.Collections.Generic.Dictionary&lt;Vec2, char&gt;;
record struct Vec2(int x, int y);

[ProblemName(&quot;Keypad Conundrum&quot;)]
class Solution : Solver {

    public object PartOne(string input) =&gt; Solve(input, 2);

    public object PartTwo(string input) =&gt; Solve(input, 25);
    
    long Solve(string input, int depth) {
        var keypad1 = ParseKeypad(&quot;789\n456\n123\n 0A&quot;);
        var keypad2 = ParseKeypad(&quot; ^A\n&lt;v&gt;&quot;);
        var keypads = Enumerable.Repeat(keypad2, depth).Prepend(keypad1).ToArray();

        var cache = new Cache();
        var res = 0L;

        foreach (var line in input.Split(&quot;\n&quot;)) {
            var num = int.Parse(line[..^1]);
            res += num * EncodeKeys(line, keypads, cache);
        }
        return res;
    }

    // Determines the length of the shortest sequence that is needed to enter the given 
    // keys. An empty keypad array means that the sequence is simply entered by a human 
    // and no further encoding is needed. Otherwise the sequence is entered by a robot
    // which needs to be programmed. In practice this means that the keys are encoded 
    // using the robots keypad (the first keypad), generating an other sequence of keys.
    // This other sequence is then recursively encoded using the rest of the keypads.
    long EncodeKeys(string keys, Keypad[] keypads, Cache cache) {
        if (keypads.Length == 0) {
            return keys.Length;
        } else {
            // invariant: the robot starts and finishes by pointing at the &#039;A&#039; key
            var currentKey = &#039;A&#039;;
            var length = 0L;

            foreach (var nextKey in keys) {
                length += EncodeKey(currentKey, nextKey, keypads, cache);
                // while the sequence is entered the current key changes accordingly
                currentKey = nextKey;
            }

            // at the end the current key should be reset to &#039;A&#039;
            Debug.Assert(currentKey == &#039;A&#039;, &quot;The robot should point at the &#039;A&#039; key&quot;);
            return length;
        }
    }
    long EncodeKey(char currentKey, char nextKey, Keypad[] keypads, Cache cache) =&gt;
       cache.GetOrAdd((currentKey, nextKey, keypads.Length), _ =&gt; {
           var keypad = keypads[0];

           var currentPos = keypad.Single(kvp =&gt; kvp.Value == currentKey).Key;
           var nextPos = keypad.Single(kvp =&gt; kvp.Value == nextKey).Key;

           var dy = nextPos.y - currentPos.y;
           var vert = new string(dy &lt; 0 ? &#039;v&#039; : &#039;^&#039;, Math.Abs(dy));

           var dx = nextPos.x - currentPos.x;
           var horiz = new string(dx &lt; 0 ? &#039;&lt;&#039; : &#039;&gt;&#039;, Math.Abs(dx));

           var cost = long.MaxValue;
           // we can usually go vertical first then horizontal or vica versa,
           // but we should check for the extra condition and don&#039;t position
           // the robot over the &#039; &#039; key:
           if (keypad[new Vec2(currentPos.x, nextPos.y)] != &#039; &#039;) {
               cost = Math.Min(cost, EncodeKeys($&quot;{vert}{horiz}A&quot;, keypads[1..], cache));
           }

           if (keypad[new Vec2(nextPos.x, currentPos.y)] != &#039; &#039;) {
               cost = Math.Min(cost, EncodeKeys($&quot;{horiz}{vert}A&quot;, keypads[1..], cache));
           }
           return cost;
       });

    Keypad ParseKeypad(string keypad) {
        var lines = keypad.Split(&quot;\n&quot;);
        return (
            from y in Enumerable.Range(0, lines.Length)
            from x in Enumerable.Range(0, lines[0].Length)
            select new KeyValuePair&lt;Vec2, char&gt;(new Vec2(x, -y), lines[y][x])
        ).ToDictionary();
    }
}</code></pre></div>
            <div id="code-location"> <p>Please ☆ my <a href="https://github.com/encse/adventofcode/">repo</a> if you like it!</p></div>
        </div>

    </div>
    <div id="bottom">
        <span>© <span id="currentYear">2024</span></span>
        <span><a href="https://adventofcode.com">Advent of Code</a> is a registered trademark in the US</span>
        <span>Images provided by <a href="https://www.bing.com/images/create">Bing</a> image creator</span>
    </div>
 
    <script>
        // This will automatically apply highlight.js to all <pre><code> blocks
        document.addEventListener('DOMContentLoaded', function () {

        let yearPicker = document.querySelector('#year-picker select')
        if (yearPicker) {
            yearPicker.addEventListener('change', function () {
                window.location = this.value;
            });
        }

          // Automatically highlight all <code> blocks inside <pre>
          hljs.highlightAll();
        });
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P8Y1BWSSF3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-P8Y1BWSSF3');
    </script>
</body>

</html>