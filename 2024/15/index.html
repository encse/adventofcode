<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <link href='https://fonts.googleapis.com/css?family=Noto Sans' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/csharp.min.js"></script>
    <title>Advent of Code 2024/15 'Warehouse Woes'' in C# by encse</title>

    <head>
        <meta property="og:title" content="Advent of Code 2024/15 'Warehouse Woes' in C# by encse">
        <meta property="og:description" content="C# solution to the 'Warehouse Woes' Advent of Code problem.">
        <meta property="og:image" content="https://aoc.csokavar.hu/2024/15//illustration.jpg">
        <meta property="og:url" content="https://aoc.csokavar.hu/2024/15/">
        <meta property="og:type" content="website">
      </head>


    <style>
        html {
            --theme-background-color: #2b2b2b;
            --theme-background-color2: #0d1117;
        }

        * {
            box-sizing: border-box;
            /* text is too big without these in my iphone */
            -moz-text-size-adjust: none;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }

        @media (min-width:2000px) {
            html {
                font-size: 1.9em;
            }
        }

        a {
            color: inherit;
        }

        body {
            background: var(--theme-background-color);
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans', 'Arial', sans-serif;
            color: white;
        }

        .main {
            width: 100ch;
            display: flex;
            flex-direction: column;
            padding: 1em;
            margin: 4em auto;
        }


        .header-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap-reverse;
            justify-content: center;
            gap: 1em;
            overflow: hidden;
            position: relative;
        }

        .header-image {
            display: flex;
            min-width: 400px;
            position: relative;
            position: absolute;
            z-index: -1;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .header-image img {
            object-fit: cover;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.7); 
            padding: 10em;
            background-image: radial-gradient(rgba(194, 194, 194, 0.13), rgba(195, 195, 195, 0.25));
        }

        .header-title h2 {
            font-size: 400%;
            margin: 0;
        }

        .header-title p {
            font-size: 150%;
        }

        #dropdown-label {
            text-align: center;
            margin: 1em;
        }

        .dropdown-toggle {
            display: none; /* Hide the checkbox */
        }

        .dropdown-content {
            display: none;
            position: absolute;
            z-index: 1;
            list-style: none;
            background-color: #0d1117;
        }

        .dropdown-content {
            flex-direction: column;

        }

        .dropdown-content a {
            margin: 0.5em 1em;
        }

        #dropdown-toggle:checked  ~ .dropdown-content {
            display: flex; 
        }

        #top-nav,
        #bottom {
            background: var(--theme-background-color2);
            padding: 1em;
        }

        #year-picker select {
            border: none;
            background: inherit;
            font-size: inherit;
            color: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        #top-nav a,
        .header-container a {
            text-decoration: none;
        }

        #top-nav .current {
            color: var(--theme-background-color2);
            background: white;
        }

        #bottom {
            background: var(--theme-background-color2);
            display: flex;
            flex-wrap: wrap;
            gap: 2em;
            justify-content: center;
        }

        #top-nav {
            display: flex;
        }

        #top-nav select {
            margin-left: 1em;
            margin-right: 1em;
        }

        #day-picker {
            display: flex;
            flex-wrap: wrap;
        }

        #day-picker a {
            margin: 1em;
        }

        #code-container {
            overflow: auto;
            scroll-behavior: smooth;
        }

        .hljs {
            background: var(--theme-background-color2);
        }

        .hljs-ln-numbers {
            padding-right: 1em !important;
            text-align: right;
        }

        .content {
            line-height: 1.5;
            margin-top: 2em;
            /* hyphens: auto; */
        }

        .content img {
            width: 70%;
        }


        @media (max-width: 1024px) {
            .main {
                width: inherit;
            }

            .content {
                width: 100%;
            }


            #top-nav span,
            #top-nav .dropdown 
            #top-nav .dropdown-content {
                padding: 0.25em;
            }

            .header-title h2 {
                font-size: 300%;
            }
        }

        @media (orientation: landscape) {
            main {
                width: 90%;
            }
        }
    </style>
</head>

<body lang="en-US">
    <div id="top-nav">
        <div id="year-picker"><nav class="dropdown">
            <input type="checkbox" id="dropdown-toggle" class="dropdown-toggle">
            <span class="current"><label id="dropdown-label" for="dropdown-toggle">2024</label></span>
            <div class="dropdown-content"><a href="/2015/25/">2015</a><a href="/2016/25/">2016</a><a href="/2017/25/">2017</a><a href="/2018/25/">2018</a><a href="/2019/25/">2019</a><a href="/2020/25/">2020</a><a href="/2021/25/">2021</a><a href="/2022/25/">2022</a><a href="/2023/25/">2023</a><a href="/2024/25/">2024</a><a href="/2025/1/">2025</a></div>
        </nav>
     </div>
        <div id="day-picker"><span><a href="/2024/1">01</a></span><span><a href="/2024/2">02</a></span><span><a href="/2024/3">03</a></span><span><a href="/2024/4">04</a></span><span><a href="/2024/5">05</a></span><span><a href="/2024/6">06</a></span><span><a href="/2024/7">07</a></span><span><a href="/2024/8">08</a></span><span><a href="/2024/9">09</a></span><span><a href="/2024/10">10</a></span><span><a href="/2024/11">11</a></span><span><a href="/2024/12">12</a></span><span><a href="/2024/13">13</a></span><span><a href="/2024/14">14</a></span><span class="current"><a href="/2024/15">15</a></span><span><a href="/2024/16">16</a></span><span><a href="/2024/17">17</a></span><span><a href="/2024/18">18</a></span><span><a href="/2024/19">19</a></span><span><a href="/2024/20">20</a></span><span><a href="/2024/21">21</a></span><span><a href="/2024/22">22</a></span><span><a href="/2024/23">23</a></span><span><a href="/2024/24">24</a></span><span><a href="/2024/25">25</a></span></div>
    </div>
    <div class="main">
        <div class="header-container">
            <div class="header-image">
                <img id="cover" width="100%" src="illustration.jpg" />
            </div>

            <div class="header-title">
                <p class="text">Advent of Code</p>
                <h2 id="problem-id">2024/15</h2>
                <h2 id="problem-name">Warehouse Woes</h2>
                <p class="text">in C#</p>
                <p class="text"></p>
                <p class="text"><em>by <a style="text-decoration: underline"
                            href="https://github.com/sponsors/encse">encse</a></em></p>
            </div>

        </div>

        <div class="content">
            <div id="notes"><p>You appear back inside your own mini submarine! Each Historian drives their mini submarine in a different direction; maybe the Chief has his own submarine down here somewhere as well?</p>
<p>You look up to see a vast school of <a href="/2021/day/6">lanternfish</a> swimming past you. On closer inspection, they seem quite anxious, so you drive your mini submarine over to see if you can help.</p>
<p><em>Visit the website for the full story and <a href="https://adventofcode.com/2024/day/15">full puzzle</a> description.</em></p>
<p>A nice Sokoban-style puzzle for the weekend! The main difference is that in the original Sokoban, the robot could push only a single box, not multiple boxes. This adds complexity to both parts of the puzzle. However, it’s not that difficult to handle... I moved the hard parts into the <code>TryToStep</code> function that takes the map, a position, and a direction, then attempts to make a move in that direction.</p>
<p>If the position corresponds to the robot or a box, the function checks whether the neighboring cell is free or can be made free by pushing boxes in the given direction. The .NET API sometimes uses the <code>TryToDoX</code> pattern, where a function returns a boolean result and provides an <code>out</code> parameter. I reused this pattern here. On success, the updated map is returned via the <code>ref</code> parameter. If the move fails, the map remains unchanged. </p>
<p>The real challenge lies in <code>part 2</code>, where recursion needs to branch whenever the robot pushes more than one box at a time. In such cases, we must invoke <code>TryToStep</code> for each box. Due to the recursive nature of the algorithm, it’s possible for one branch to succeed while the other fails. When this happens, the entire map must be reset to its original state before we pop from the recursion. This could be quite tricky to manage unless you make copies of the dictionary that holds the state — or, as I did, use an immutable dictionary instead.</p>
<p>I’m not entirely satisfied with the &quot;if-ladder&quot; structure of the <code>TryToStep</code> function, but for now, I don’t have a better idea to handle all the cases in a more readable way.</p>
</div>
            <div id="code-container"><pre class="hljs language-csharp"><code>namespace AdventOfCode.Y2024.Day15;

using System;
using System.Collections.Generic;
using System.Collections.Immutable;
using System.Linq;
using System.Numerics;

using Map = System.Collections.Immutable.IImmutableDictionary&lt;System.Numerics.Complex, char&gt;;

[ProblemName(&quot;Warehouse Woes&quot;)]
class Solution : Solver {

    static Complex Up = -Complex.ImaginaryOne;
    static Complex Down = Complex.ImaginaryOne;
    static Complex Left = -1;
    static Complex Right = 1;

    public object PartOne(string input) =&gt; Solve(input);
    public object PartTwo(string input) =&gt; Solve(ScaleUp(input));

    public double Solve(string input) {
        var (map, steps) = Parse(input);

        var robot = map.Keys.Single(k =&gt; map[k] == &#039;@&#039;);
        foreach (var dir in steps) {
            if (TryToStep(ref map, robot, dir)) {
                robot += dir;
            }
        }

        return map.Keys
            .Where(k =&gt; map[k] == &#039;[&#039; || map[k] == &#039;O&#039;)
            .Sum(box =&gt; box.Real + 100 * box.Imaginary);
    }

    // Attempts to move the robot in the given direction on the map, pushing boxes as necessary.
    // If the move is successful, the map is updated to reflect the new positions and the function returns true.
    // Otherwise, the map remains unchanged and the function returns false.
    bool TryToStep(ref Map map, Complex pos, Complex dir) {
        var mapOrig = map;

        if (map[pos] == &#039;.&#039;) {
            return true;
        } else if (map[pos] == &#039;O&#039; || map[pos] == &#039;@&#039;) {
            if (TryToStep(ref map, pos + dir, dir)) {
                map = map
                    .SetItem(pos + dir, map[pos])
                    .SetItem(pos, &#039;.&#039;);
                return true;
            }
        } else if (map[pos] == &#039;]&#039;) {
            return TryToStep(ref map, pos + Left, dir);
        } else if (map[pos] == &#039;[&#039;) {
            if (dir == Left) {
                if (TryToStep(ref map, pos + Left, dir)) {
                    map = map
                        .SetItem(pos + Left, &#039;[&#039;)
                        .SetItem(pos, &#039;]&#039;)
                        .SetItem(pos + Right, &#039;.&#039;);
                    return true;
                }
            } else if (dir == Right) {
                if (TryToStep(ref map, pos + 2 * Right, dir)) {
                    map = map
                        .SetItem(pos, &#039;.&#039;)
                        .SetItem(pos + Right, &#039;[&#039;)
                        .SetItem(pos + 2 * Right, &#039;]&#039;);
                    return true;
                }
            } else {
                if (TryToStep(ref map, pos + dir, dir) &amp;&amp; TryToStep(ref map, pos + Right + dir, dir)) {
                    map = map
                        .SetItem(pos, &#039;.&#039;)
                        .SetItem(pos + Right, &#039;.&#039;)
                        .SetItem(pos + dir, &#039;[&#039;)
                        .SetItem(pos + dir + Right, &#039;]&#039;);
                    return true;
                }
            }
        }

        map = mapOrig;
        return false;
    }

    string ScaleUp(string input) =&gt;
        input.Replace(&quot;#&quot;, &quot;##&quot;).Replace(&quot;.&quot;, &quot;..&quot;).Replace(&quot;O&quot;, &quot;[]&quot;).Replace(&quot;@&quot;, &quot;@.&quot;);

    (Map, Complex[]) Parse(string input) {
        var blocks = input.Split(&quot;\n\n&quot;);
        var lines = blocks[0].Split(&quot;\n&quot;);
        var map = (
            from y in Enumerable.Range(0, lines.Length)
            from x in Enumerable.Range(0, lines[0].Length)
            select new KeyValuePair&lt;Complex, char&gt;(x + y * Down, lines[y][x])
        ).ToImmutableDictionary();

        var steps = blocks[1].ReplaceLineEndings(&quot;&quot;).Select(ch =&gt;
            ch switch {
                &#039;^&#039; =&gt; Up,
                &#039;&lt;&#039; =&gt; Left,
                &#039;&gt;&#039; =&gt; Right,
                &#039;v&#039; =&gt; Down,
                _ =&gt; throw new Exception()
            });

        return (map, steps.ToArray());
    }
}
</code></pre></div>
            <div id="code-location"> <p>Please ☆ my <a href="https://github.com/encse/adventofcode/">repo</a> if you like it!</p></div>
        </div>

    </div>
    <div id="bottom">
        <span>© <span id="currentYear">2025</span></span>
        <span><a href="https://adventofcode.com">Advent of Code</a> is a registered trademark in the US</span>
        <span>Images provided by <a href="https://www.bing.com/images/create">Bing</a> image creator</span>
    </div>
 
    <script>
        // This will automatically apply highlight.js to all <pre><code> blocks
        document.addEventListener('DOMContentLoaded', function () {

        let yearPicker = document.querySelector('#year-picker select')
        if (yearPicker) {
            yearPicker.addEventListener('change', function () {
                window.location = this.value;
            });
        }

          // Automatically highlight all <code> blocks inside <pre>
          hljs.highlightAll();
        });
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P8Y1BWSSF3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-P8Y1BWSSF3');
    </script>
</body>

</html>